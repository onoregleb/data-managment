# =============================================================================
# GitLab CI/CD Pipeline Ð´Ð»Ñ Blockchain Data Pipeline
# =============================================================================

stages:
  - lint
  - test
  - deploy

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  POSTGRES_DB: blockchain_test
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres

# ÐšÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ pip Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
cache:
  paths:
    - .cache/pip/

# =============================================================================
# Lint - ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° ÐºÐ¾Ð´Ð°
# =============================================================================
lint:
  stage: lint
  image: python:3.11-slim
  script:
    - pip install black isort flake8 sqlfluff
    - echo "ðŸ” Checking Python formatting (black)..."
    - black --check --line-length=100 app/ airflow/
    - echo "ðŸ” Checking imports (isort)..."
    - isort --check-only --profile=black app/ airflow/
    - echo "ðŸ” Linting Python (flake8)..."
    - flake8 --max-line-length=100 --ignore=E501,W503 app/ airflow/
    - echo "ðŸ” Linting SQL (sqlfluff)..."
    - sqlfluff lint dwh/ --dialect postgres || true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"

# =============================================================================
# Test - Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ DBT Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹
# =============================================================================
test:
  stage: test
  image: python:3.11-slim
  services:
    - name: postgres:15-alpine
      alias: postgres
  variables:
    POSTGRES_DB: blockchain_test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
  before_script:
    - apt-get update && apt-get install -y postgresql-client
    - pip install dbt-postgres
    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ test profiles.yml
    - mkdir -p ~/.dbt
    - |
      cat > ~/.dbt/profiles.yml << EOF
      blockchain:
        target: dev
        outputs:
          dev:
            type: postgres
            host: postgres
            port: 5432
            user: postgres
            password: postgres
            dbname: blockchain_test
            schema: public
            threads: 2
      EOF
  script:
    - echo "ðŸ“¦ Initializing test database..."
    - PGPASSWORD=postgres psql -h postgres -U postgres -d blockchain_test -f dwh/01_init.sql
    - echo "ðŸ”§ DBT debug..."
    - cd dbt && dbt debug
    - echo "ðŸ—ï¸ DBT run..."
    - cd dbt && dbt run || true
    - echo "âœ… DBT test..."
    - cd dbt && dbt test || true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
  needs:
    - lint

# =============================================================================
# Deploy - ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
# =============================================================================
deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client sshpass
  script:
    - echo "ðŸš€ Deploying to production server..."
    - |
      sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'ENDSSH'
        cd ~/data-managment
        git pull origin master || git pull origin main
        docker compose pull
        docker compose up -d --build
        docker compose ps
        echo "âœ… Deployment completed successfully!"
      ENDSSH
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
  needs:
    - lint
    - test
  when: manual  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð´ÐµÐ¿Ð»Ð¾Ñ (Ð¼Ð¾Ð¶Ð½Ð¾ ÑƒÐ±Ñ€Ð°Ñ‚ÑŒ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾)
